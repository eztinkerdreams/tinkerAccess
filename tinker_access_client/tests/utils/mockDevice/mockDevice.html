<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Mock Device</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        body {
            margin: 0px;
        }

        .HIGH {
            background-color: #90EE90;
        }

        .LOW {
            background-color: #CD5C5C;
        }

        .pin {
            padding: 2px;
            border-radius: 5px;
        }

        .pinLabel {
            float: right;
            font-size: 12px;
        }

        .pinDesc {
            clear: both;
        }

        #pinTable {
            background-color: black;
            width: 930px;
            font-family: monospace;
            font-size: 8px;
        }

        .pin button {
            width: 40px;
            font-size: 8px;
            padding: 0px 3px 0px 3px;

        }
    </style>
    <script type="text/javascript">
        (function (device, $, undefined) {
            var host = 'http://127.0.0.1:2020/',
                getUrl = host + 'get.json',
                sendUrl = host + 'send';

            device.start = function () {
                setInterval(updateStatus, 200);
            };

            function updateStatus() {
                $.get(getUrl, function (data) {
                    var status = JSON.parse(data || '{ pins: [], lcd: [] }');

                    if ($('#pinTable').length) {
                        $.map(status, function(rowValues) {
                            $.map(rowValues, function(pinValue) {
                                updatePinStatus(pinValue.pin, (pinValue.status ? 'HIGH' : 'LOW'))
                            });
                        });

                        return;
                    }


                    var rowValues = $.map(status, function (rowValues) {
                        var pinElements = $.map(rowValues, function (pinData) {
                            var pin = +pinData.pin,
                                desc = pinData.desc,
                                status = pinData.status;

                            return $('<td />', {
                                id: 'p' + pin,
                                pin: pin,
                                class: 'pin ' + (status ? 'HIGH' : 'LOW'),
                                html: [
                                    $('<input />', {
                                        type: 'checkbox',
                                        click: togglePinStatus,
                                        checked: (status ? 'checked' : false)
                                    }),
                                    $('<span />', { text: pin, class: 'pinLabel' }),
                                    $('<div />', { text: desc, class: 'pinDesc' }),
                                    $('<button />', {
                                        mouseup: togglePinStatus,
                                        mousedown: togglePinStatus,
                                        text: (status ? 'HIGH' : 'LOW')
                                    })
                                ]
                            });
                        });
                        return [pinElements];
                    });

                    //TOOD: leds

                    /*
                    var rfidScanner = $('</div>', {
                        class: 'rfidScanner',
                        html: [
                            $('<input />', { type: 'text' }),
                            $('<button />', { text: 'scan', onClick: function(){
                                console.info('not implemented');
                                }
                            })
                        ]
                    });

                    var lcdPanel = $('<div />', {
                        class: 'lcdPanel',
                        text: 'todo'
                    });

                    var resetButton = $('<button />', {
                        class: 'resetButton',
                        mousedown: function() { togglePinStatus({ target: $('#p16') })},
                        mouseup: function() { togglePinStatus({ target: $('#p16') })}
                    });

                    var components = [
                        lcdPanel,
                        resetButton
                    ];
                    */
                    var rowElements =  $.map(rowValues, function(row) { return $('<tr />', { html: row })});

                    $('<table />', {
                        id: 'pinTable',
                        html: rowElements
                    }).appendTo(document.body);

                }).fail(function (response) {
                    console.error(response)
                });
            }

            function togglePinStatus(e) {
                var pin = $(e.target).closest('.pin');
                var checkbox = $(':checkbox', pin);
                var currentStatus = !!$(checkbox).prop('checked');
                var newStatus = !currentStatus;
                if (!$(e.target).is(':checkbox')) {
                    $(checkbox).prop('checked', newStatus);
                }

                updatePinStatus(pin, newStatus);
                sendPin($(pin).attr('pin'), newStatus);
            }

            function updatePinStatus(pin, status) {
                var checkbox = $(':checkbox', pin);
                var button = $(':button', pin);
                $(checkbox).attr('checked', status);
                $(pin).toggleClass('HIGH LOW');
                $(button).text((status ? 'HIGH' : 'LOW'))
            }

            function sendPin(pin, status) {
                $.post(sendUrl, { pin: pin, status: status }, function() {
                    console.info('pin %s went from %s to %s', pin,
                    (status ? 'HIGH' : 'LOW'), (!status ? 'HIGH' : 'LOW'));
                }).fail(function(response) {
                    console.error(response)
                });
            }

        }(window.device = window.device || {}, jQuery));
        device.start();
    </script>
</head>
<body />
</html>